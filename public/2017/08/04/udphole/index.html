<!doctype html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="C++ python 大并发网络 逆向">
  <meta name="description" content="重剑无锋，大巧不工">
  <meta name="author" content="恋恋风辰">

  
  <title>Udp打洞原理和源代码。</title>
  

  <link rel="alternate" href="/atom.xml" title="恋恋风辰的个人博客" type="application/atom+xml">
  <link rel="canonical" href="http://www.limerence2017.com/2017/08/04/udphole/index.html">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="//at.alicdn.com/t/font_pb2xepysv85gsyvi.css">
  <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang"></i><a href="/index.html" class="aside-menu-link" title="首页">首页</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-wendang1"></i><a href="/archives/index.html" class="aside-menu-link" title="所有文章">所有文章</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-biaoqian1"></i><a href="/tags/index.html" class="aside-menu-link" title="文章分类">文章分类</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-lianjie"></i><a href="/links/index.html" class="aside-menu-link" title="我和我的小伙伴">我和我的小伙伴</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-guanyu"></i><a href="/about/index.html" class="aside-menu-link" title="作者简介">作者简介</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-rss"></i><a href="/atom.xml" class="aside-menu-link" title="RSS">RSS</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value="" autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-houdongfangiconfont10"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.png" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          恋恋风辰
          
          <strong class="aside-avatar-STRONG">个人博客</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">重剑无锋，大巧不工。</p>
      <ul class="aside-show-info">
        <li class="aside-show-item">
          <a href="javascript: void(0);" class="aside-show-link" title="微信" target="_blank"><i class="aside-show-icon iconfont icon-iconfontweixin"></i></a>
          <div class="aside-show-outside aside-show-outside_1">
            <img class="aside-show-IMG aside-show-IMG_1" src="/img/weixin.png" alt="微信">
          </div>
        </li>
        <li class="aside-show-item"><a href="https://www.zhihu.com/people/wang-wu-chen-32/activities" class="aside-show-link" title="知乎" target="_blank"><i class="aside-show-icon iconfont icon-zhihu"></i></a></li>
        <li class="aside-show-item"><a href="https://github.com/secondtonone1" class="aside-show-link" title="github" target="_blank"><i class="aside-show-icon iconfont icon-github"></i></a></li>
        <li class="aside-show-item">
          <a href="javascript: void(0);" class="aside-show-link" title="QQ" target="_blank"><i class="aside-show-icon iconfont icon-qq"></i></a>
          <div class="aside-show-outside">
            <img class="aside-show-IMG" src="/img/qq.png" alt="QQ">
          </div>
        </li>
      </ul>
    </div>
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Udp打洞原理和源代码。</h1>
    <p class="post-meta">
      <span class="post-time">2017-08-04</span>
      
      <a href="/categories/tech/" title="技术开发" class="post-categories">技术开发</a>
      
      
      <a href="/tags/网络编程/"" title="网络编程" class="post-tags"><i class="post-tags-icon iconfont icon-biaoqian"></i>网络编程</a>
      
    </p>
    
  </header>
  <div class="post-content"><p>所谓<code>udp打洞</code>就是指客户端A通过<code>udp协议</code>向服务器发送数据包，服务器收到后，获取数据包，并且可获取客户端A<code>地址和端口号</code>。同样在客户端B发送给服务器udp数据包后，服务器同样在收到B发送过来的数据包后获取B的地址和端口号，将A和B的地址与端口号分别发送给对方，这样双方可以继续用UDP协议通信。这么做有什么用呢？因为对于一些应用或者需求，需要两个客户端临时做一些通信，而这种通信不需要建立tcp就可以完成，所以才去udp打洞。</p>
<p>下面附上测试代码：</p>
<p>头文件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// udphole.cpp : 定义控制台应用程序的入口点。</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WIN32</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdafx.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">"Ws2_32.lib"</span>)</span></div><div class="line"><span class="keyword">typedef</span> SOCKET socketfd;</div><div class="line"><span class="keyword">typedef</span> SOCKADDR_IN sockaddr_in;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __linux__</span></div><div class="line"></div><div class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></div><div class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></div><div class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></div><div class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></div><div class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> socketfd;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;list&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>服务器端核心代码。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;list&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> WIN32</span></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">list</span>&lt;SOCKADDR_IN&gt; addrList;</div><div class="line"></div><div class="line">    WSADATA    wsaData = &#123;<span class="number">0</span>&#125;;</div><div class="line">    <span class="keyword">if</span> (<span class="number">0</span> != WSAStartup(MAKEWORD(<span class="number">2</span>,<span class="number">2</span>), &amp;wsaData))</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">printf</span> (<span class="string">"WSAStartup failed. errno=[%d]\n"</span>, WSAGetLastError());</div><div class="line">        <span class="keyword">return</span>    <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __linux__</span></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">list</span>&lt;sockaddr_in&gt; addrList;</div><div class="line">    </div><div class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="comment">//addrList 是地址列表，每次存放最新到来的。</span></div><div class="line">    socketfd sockServer = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP);</div><div class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == sockServer)</div><div class="line">    &#123;</div><div class="line"></div><div class="line">        <span class="meta">#<span class="meta-keyword">ifdef</span> WIN32</span></div><div class="line">        <span class="built_in">printf</span> (<span class="string">"socket server failed. errno=[%d]\n"</span>, WSAGetLastError());</div><div class="line">        <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">        <span class="meta">#<span class="meta-keyword">ifdef</span> __linx__</span></div><div class="line">        <span class="built_in">printf</span>(<span class="string">"socket server failed. errno=[%d]\n"</span>, errno);</div><div class="line">        <span class="meta">#<span class="meta-keyword">endif</span>    </span></div><div class="line">    </div><div class="line">        <span class="keyword">return</span>    <span class="number">-2</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    sockaddr_in    addrServer = &#123;<span class="number">0</span>&#125;;</div><div class="line">    </div><div class="line">    addrServer.sin_family    = AF_INET;</div><div class="line">    addrServer.sin_addr.s_addr = INADDR_ANY;<span class="comment">//inet_addr("192.168.1.2");</span></div><div class="line">    addrServer.sin_port = htons(<span class="number">10000</span>);</div><div class="line">    <span class="keyword">if</span> (<span class="number">0</span> != bind(sockServer, (sockaddr*)&amp;addrServer, <span class="keyword">sizeof</span>(addrServer)))</div><div class="line">    &#123;</div><div class="line">        <span class="meta">#<span class="meta-keyword">ifdef</span> WIN32</span></div><div class="line">        <span class="built_in">printf</span> (<span class="string">"bind server failed.errno=[%d]\n"</span>, WSAGetLastError());</div><div class="line">        <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">        <span class="meta">#<span class="meta-keyword">ifdef</span> __linux__</span></div><div class="line">        <span class="built_in">printf</span>(<span class="string">"bind server failed.errno=[%d]\n"</span>, errno);</div><div class="line">        <span class="meta">#<span class="meta-keyword">endif</span>        </span></div><div class="line"></div><div class="line">        <span class="keyword">return</span>    <span class="number">-3</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"okok6"</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">char</span>    pcContent1[<span class="number">10240</span>] = &#123;<span class="number">0</span>&#125;;</div><div class="line">        sockaddr_in    addrUser1 = &#123;<span class="number">0</span>&#125;;</div><div class="line">        <span class="meta">#<span class="meta-keyword">ifdef</span> WIN32</span></div><div class="line">        <span class="keyword">int</span>    nLen1 = <span class="keyword">sizeof</span>(addrUser1);</div><div class="line">        <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">        <span class="meta">#<span class="meta-keyword">ifdef</span> __linux__</span></div><div class="line">        <span class="keyword">socklen_t</span> nLen1 = <span class="keyword">sizeof</span>(addrUser1);</div><div class="line">        <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">        <span class="comment">//服务器接收来自客户端的消息，并且用addrUser1保存地址和端口</span></div><div class="line">        <span class="keyword">if</span> (<span class="number">-1</span> == recvfrom(sockServer, pcContent1, <span class="keyword">sizeof</span>(pcContent1), <span class="number">0</span>, (sockaddr*)&amp;addrUser1, &amp;nLen1))</div><div class="line">        &#123;</div><div class="line">            <span class="built_in">cout</span> &lt;&lt; <span class="string">"dfdfda"</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line"></div><div class="line">            <span class="meta">#<span class="meta-keyword">ifdef</span> WIN32</span></div><div class="line">            <span class="built_in">printf</span> (<span class="string">"recv user 1 failed.errno=[%d]"</span>, WSAGetLastError());</div><div class="line">            <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">            <span class="meta">#<span class="meta-keyword">ifdef</span> __linux__</span></div><div class="line">            <span class="built_in">printf</span> (<span class="string">"recv user 1 failed.errno=[%d]"</span>, errno);</div><div class="line">            <span class="meta">#<span class="meta-keyword">endif</span>            </span></div><div class="line"></div><div class="line">            <span class="keyword">return</span>    <span class="number">-4</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> </div><div class="line">        &#123;</div><div class="line">            </div><div class="line">            <span class="comment">//</span></div><div class="line">            <span class="built_in">printf</span> (<span class="string">"connect user ip=[%s] port=[%d]\n"</span>, inet_ntoa(addrUser1.sin_addr), htons(addrUser1.sin_port));</div><div class="line">           <span class="comment">//如果地址列表非空，那么取出列表中的地址，并且与最新到来的客户端通信</span></div><div class="line">            <span class="keyword">if</span>(addrList.size())</div><div class="line">            &#123;</div><div class="line">                sockaddr_in peerAddr = addrList.front();</div><div class="line">                <span class="keyword">int</span> nLen2 = <span class="keyword">sizeof</span>(peerAddr);</div><div class="line">                <span class="built_in">printf</span> (<span class="string">"peer user ip=[%s] port=[%d]\n"</span>, inet_ntoa(peerAddr.sin_addr), htons(peerAddr.sin_port));</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (<span class="number">-1</span> == sendto(sockServer, (<span class="keyword">char</span>*)&amp;addrUser1, nLen1, <span class="number">0</span>, (sockaddr*)&amp;peerAddr, nLen2))</div><div class="line">                &#123;</div><div class="line">                    <span class="meta">#<span class="meta-keyword">ifdef</span> WIN32</span></div><div class="line">                     <span class="built_in">printf</span> (<span class="string">"send to peer user  data failed.\n"</span>, WSAGetLastError());</div><div class="line">                    <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">                    <span class="meta">#<span class="meta-keyword">ifdef</span> __linux__</span></div><div class="line">                     <span class="built_in">printf</span> (<span class="string">"send to peer user  data failed.\n"</span>, errno);</div><div class="line">                    <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">                    <span class="keyword">return</span>    <span class="number">-6</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (<span class="number">-1</span> == sendto(sockServer, (<span class="keyword">char</span>*)&amp;peerAddr, nLen2, <span class="number">0</span>, (sockaddr*)&amp;addrUser1, nLen1))</div><div class="line">                &#123;</div><div class="line">                    <span class="meta">#<span class="meta-keyword">ifdef</span> WIN32</span></div><div class="line">                    <span class="built_in">printf</span> (<span class="string">"send to connect user  data failed.\n"</span>, WSAGetLastError());</div><div class="line">                    <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">                    <span class="meta">#<span class="meta-keyword">ifdef</span> __linux__</span></div><div class="line">                     <span class="built_in">printf</span> (<span class="string">"send to connect user  data failed.\n"</span>, errno);</div><div class="line">                    <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">                    <span class="keyword">return</span>    <span class="number">-6</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                addrList.pop_front();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;</div><div class="line">                <span class="comment">//如果列表为空，那么将该地址放入列表中。</span></div><div class="line">                addrList.push_back(addrUser1);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> WIN32</span></div><div class="line">    Sleep(INFINITE);</div><div class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __linux__</span></div><div class="line">    <span class="comment">//sleep(1000);</span></div><div class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面是客户端发送消息的代码，比较简单。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdafx.h"</span></span></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winsock2.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">"Ws2_32.lib"</span>)</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">int</span> _tmain(<span class="keyword">int</span> argc, _TCHAR* argv[])</div><div class="line">&#123;</div><div class="line">    WSADATA    wsaData = &#123;<span class="number">0</span>&#125;;</div><div class="line">    <span class="keyword">if</span> (<span class="number">0</span> != WSAStartup(MAKEWORD(<span class="number">2</span>,<span class="number">2</span>), &amp;wsaData))</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">printf</span> (<span class="string">"WSAStartup failed. errno=[%d]\n"</span>, WSAGetLastError());</div><div class="line">        <span class="keyword">return</span>    <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">    SOCKET    sockClient = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP);</div><div class="line">    <span class="keyword">if</span> (SOCKET_ERROR == sockClient)</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">printf</span> (<span class="string">"socket server failed. errno=[%d]\n"</span>, WSAGetLastError());</div><div class="line">        <span class="keyword">return</span>    <span class="number">-2</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">char</span>    pcContent1[UCHAR_MAX] = &#123;<span class="number">0</span>&#125;;</div><div class="line">    SOCKADDR_IN    addrServer = &#123;<span class="number">0</span>&#125;;</div><div class="line">    addrServer.sin_family    = AF_INET;</div><div class="line">    addrServer.sin_addr.s_addr    = inet_addr(<span class="string">"192.168.1.40"</span>);</div><div class="line">    addrServer.sin_port    = htons(<span class="number">10000</span>);</div><div class="line">    <span class="keyword">int</span>    nLen1 = <span class="keyword">sizeof</span>(addrServer);</div><div class="line">    <span class="comment">//客户端发送自己的报文</span></div><div class="line">    <span class="keyword">if</span> (SOCKET_ERROR == sendto(sockClient, pcContent1, <span class="number">1</span>, <span class="number">0</span>, (sockaddr*)&amp;addrServer, nLen1))</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">printf</span> (<span class="string">"recv user 1 failed.errno=[%d]"</span>, WSAGetLastError());</div><div class="line">        <span class="keyword">return</span>    <span class="number">-3</span>;</div><div class="line">    &#125;</div><div class="line">    SOCKADDR_IN    addrUser = &#123;<span class="number">0</span>&#125;;</div><div class="line">    <span class="keyword">char</span>    pcContent2[UCHAR_MAX] = &#123;<span class="number">0</span>&#125;;</div><div class="line">    <span class="comment">//阻塞接收来自服务器的消息。</span></div><div class="line">    <span class="keyword">if</span> (SOCKET_ERROR == recvfrom(sockClient, pcContent2, <span class="keyword">sizeof</span>(pcContent2), <span class="number">0</span>, (sockaddr*)&amp;addrServer, &amp;nLen1))</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">printf</span> (<span class="string">"recv user 1 failed.errno=[%d]"</span>, WSAGetLastError());</div><div class="line">        <span class="keyword">return</span>    <span class="number">-5</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> </div><div class="line">    &#123;</div><div class="line">        <span class="built_in">memcpy</span> (&amp;addrUser, pcContent2, <span class="keyword">sizeof</span>(addrUser));</div><div class="line">        <span class="built_in">sprintf</span> (pcContent2, <span class="string">"hello, user ip=[%s] port=[%d]\n"</span>, inet_ntoa(addrUser.sin_addr), htons(addrUser.sin_port));</div><div class="line">        <span class="comment">//解析服务器消息后发送消息给另一个客户端。</span></div><div class="line">        <span class="keyword">if</span> (SOCKET_ERROR == sendto(sockClient, pcContent2, <span class="built_in">strlen</span>(pcContent2), <span class="number">0</span>, (sockaddr*)&amp;addrUser, nLen1))</div><div class="line">        &#123;</div><div class="line">            <span class="built_in">printf</span> (<span class="string">"recv user 1 failed.errno=[%d]"</span>, WSAGetLastError());</div><div class="line">            <span class="keyword">return</span>    <span class="number">-3</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> </div><div class="line">        &#123;</div><div class="line">            <span class="comment">//阻塞接收另一个客户端发送过来的消息</span></div><div class="line">            <span class="keyword">if</span> (SOCKET_ERROR == recvfrom(sockClient, pcContent2, <span class="keyword">sizeof</span>(pcContent2), <span class="number">0</span>, (sockaddr*)&amp;addrServer, &amp;nLen1))</div><div class="line">            &#123;</div><div class="line">                <span class="built_in">printf</span> (<span class="string">"recv user 1 failed.errno=[%d]"</span>, WSAGetLastError());</div><div class="line">                <span class="keyword">return</span>    <span class="number">-5</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="built_in">printf</span> (<span class="string">"%s"</span>, pcContent2);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    Sleep(INFINITE);</div><div class="line">    <span class="keyword">return</span>    <span class="number">0</span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>效果如下，服务器收到来自客户端A和客户端B的报文后打印他们的信息，并且互相转发消息。<br><img src="/2017/08/04/udphole/1.png" alt="1"><br>客户端A和客户端B分别打印对方的地址和端口号<br><img src="/2017/08/04/udphole/2.png" alt="2"><br><img src="/2017/08/04/udphole/3.png" alt="3"><br>到此为止，udp打洞的代码介绍完了。可以关注我的公众号，谢谢</p>
</div>
    
      <p class="post-copyright">若无特别说明，本文系原创，<a class="post-copyright-link" href="https://creativecommons.org/licenses/by/4.0/deed.zh" title="署名-非商业性使用 4.0 (CC BY-NC 4.0)" target="_blank">署名-非商业性使用 4.0 (CC BY-NC 4.0)</a>协议，转载文章请注明来自<a class="post-copyright-link" href="/" title="恋恋风辰的个人博客" target="_blank">恋恋风辰的个人博客</a>，或链接上原文地址：<a class="post-copyright-link" href="http://www.limerence2017.com/2017/08/04/udphole/" title="http://www.limerence2017.com/2017/08/04/udphole/" target="_blank">http://www.limerence2017.com/2017/08/04/udphole/</a></p>

      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            
          </div>
        </div>
      </div>
    
  
</article>

      <footer class="footer">
  <p class="footer-text">驱动于 <a href="https://hexo.io/zh-cn/" class="footer-link" title="Hexo">Hexo</a>，主题由 <a href="/about" class="footer-link" title="恋恋风辰">恋恋风辰</a> 设计移植而来</p>
  <p class="footer-text">&copy; 2016 - 2017 <a href="/about" class="footer-link" title="恋恋风辰">恋恋风辰</a> 保留部分版权</p>
</footer>

    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
